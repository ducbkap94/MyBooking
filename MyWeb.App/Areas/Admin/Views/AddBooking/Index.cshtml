@using Microsoft.AspNetCore.Mvc.RazorPages
@using MyWeb.Common.Helpers
@using MyWeb.Common.Paging
@{
  ViewData["Title"] = "T·∫°o ƒë∆°n ƒë·∫∑t thu√™";
  Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";

}
@model PagedResult<MyWeb.Business.Dtos.Asset.Response.AssetTableResponse>

<div class="container mt-5">
  <h3 class="mb-4 text-primary">üßæ L√™n ƒë∆°n cho thu√™ thi·∫øt b·ªã</h3>

  <!-- ========== T√¨m ki·∫øm kh√°ch h√†ng ========== -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      Th√¥ng tin kh√°ch h√†ng
    </div>
    <div class="card-body">

      <div class="row g-2 align-items-end mb-2">
        <!-- Ng√†y b·∫Øt ƒë·∫ßu -->
        <div class="col-md-9">
          <label for="startDate" class="form-label">T√¨m ki·∫øm kh√°ch h√†ng</label>
          <input type="text" id="customerSearch" class="form-control"
            onkeyup="searchItem('AddBooking', '#customerSearch', '#table-container1')"
            placeholder="Nh·∫≠p t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng...">
        </div>

        <!-- Ng√†y k·∫øt th√∫c -->
        <div class="col-md-3">
          <button class="btn btn-primary" onclick="openForm('Customer','#Modal',0)" id="btnSearchCustomer">Th√™m Kh√°ch h√†ng</button>
        </div>
        <!-- B·∫£ng k·∫øt qu·∫£ t√¨m kh√°ch h√†ng -->

        <div class="table-responsive dataTables_wrapper" id="table-container1">
          @await Html.PartialAsync("Partials/_tableCustomer")
        </div>

        <!-- Form th√¥ng tin kh√°ch h√†ng -->
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label>H·ªç v√† t√™n</label>
            <input type="text" class="form-control" id="customerName" placeholder="T√™n kh√°ch h√†ng...">
          </div>
          <div class="col-md-4">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" class="form-control" id="customerPhone" placeholder="SƒêT...">
          </div>
          <div class="col-md-4">
            <label>Email</label>
            <input type="email" class="form-control" id="customerEmail" placeholder="Email (n·∫øu c√≥)...">
          </div>
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-4">
            <label>CƒÉn c∆∞·ªõc c√¥ng d√¢n</label>
            <input type="text" class="form-control" id="customerCCCD" placeholder="CƒÉn c∆∞·ªõc c√¥ng d√¢n...">
          </div>
          <div class="col-md-8">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" class="form-control" id="customerAddress" placeholder="ƒê·ªãa ch·ªâ...">
          </div>

        </div>
      </div>
    </div>

    <!-- ========== T√¨m ki·∫øm thi·∫øt b·ªã ========== -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-info text-white">
        üîç T√¨m ki·∫øm v√† th√™m thi·∫øt b·ªã cho ƒë∆°n thu√™
      </div>
      <div class="card-body">

        <div class="row g-3 align-items-end mb-3">
          <!-- Ng√†y b·∫Øt ƒë·∫ßu -->
          <div class="col-md-3">
            <label for="startDate" class="form-label">T·ª´ ng√†y thu√™:</label>
            <input type="date" class="form-control" id="startDate">
          </div>

          <!-- Ng√†y k·∫øt th√∫c -->
          <div class="col-md-3">
            <label for="endDate" class="form-label">ƒê·∫øn ng√†y:</label>
            <input type="date" class="form-control" id="endDate">
          </div>

          <!-- √î t√¨m ki·∫øm thi·∫øt b·ªã -->
          <div class="col-md-4">
            <label for="deviceSearch" class="form-label">T√™n thi·∫øt b·ªã:</label>
            <input type="text" class="form-control" id="deviceSearch" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã...">
          </div>

          <!-- N√∫t t√¨m ki·∫øm -->
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" id="btnSearchDevice"
              onclick="searchItemAsset('AddBooking', '#deviceSearch', '#startDate', '#endDate')">T√¨m thi·∫øt b·ªã</button>
          </div>
        </div>
        <div class="table-responsive dataTables_wrapper" id="table-container">
          @await Html.PartialAsync("Partials/_tableAsset")
        </div>
      </div>
    </div>

    <!-- ========== Danh s√°ch thi·∫øt b·ªã trong ƒë∆°n ========== -->
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        Chi ti·∫øt ƒë∆°n cho thu√™
      </div>
      <div class="card-body">
        <table class="table table-bordered align-middle" id="tblOrderDetail">
          <thead class="table-light">
            <tr>
              <th>STT</th>
              <th>T√™n thi·∫øt b·ªã</th>
              <th>Serial Number</th>
              <th>ƒê∆°n gi√° / ng√†y</th>
              <th>Ng√†y b·∫Øt ƒë·∫ßu thu√™</th>
              <th>Ng√†y k·∫øt th√∫c thu√™</th>
              <th>S·ªë ng√†y thu√™</th>
              <th>Gi·∫£m gi√° (%)</th>
              <th>Th√†nh ti·ªÅn</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
      <div class="card-footer text-end">
        <strong>T·ªïng ti·ªÅn: <span id="totalAmount" class="text-danger">0</span> ‚Ç´</strong>
        <button class="btn btn-primary ms-3" id="btnSaveOrder">üíæ L∆∞u ƒë∆°n h√†ng</button>
      </div>
    </div>
  </div>
<div class="modal fade" id="Modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="margin-top: 120px;">
            <div class="modal-header">
                <h5 class="modal-title">Nh·∫≠p kho thi·∫øt b·ªã</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ModalBody">

            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/assets/admin/js/adminCrud.js"></script>
    <script src="~/assets/admin/js/just-validate.production.min.js"></script>

    <script>
      $(document).ready(function () {
        let orderDetails = [];

        // ==========================
        // üßç Ch·ªçn kh√°ch h√†ng -> ƒë·ªï v√†o form
        // ==========================
        $(document).on('click', '.btnSelectCustomer', function () {
          $('#customerName').val($(this).data('name'));
          $('#customerPhone').val($(this).data('phone'));
          $('#customerEmail').val($(this).data('email'));
          $('#customerCCCD').val($(this).data('cccd'));
          $('#customerAddress').val($(this).data('address'));
          $('#tblCustomerResult tbody').empty(); // ·∫©n b·∫£ng sau khi ch·ªçn
        });


        // ==========================
        // ‚ûï Th√™m thi·∫øt b·ªã v√†o ƒë∆°n
        // ==========================
        $(document).on('click', '.btnAddDevice', function () {
          let id = $(this).data('id');
          let name = $(this).data('name');
          let seriNumber = $(this).data('seri');
          let price = $(this).data('price');

          let startDateVal = $('#startDate').val();
          let endDateVal = $('#endDate').val();

          if (!startDateVal || !endDateVal) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
            return;
          }

          let start = new Date(startDateVal);
          let end = new Date(endDateVal);
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);

          let today = new Date();
          today.setHours(0, 0, 0, 0);


          // T√≠nh s·ªë ng√†y (ƒë√£ bao g·ªìm ng√†y ƒë·∫ßu v√† ng√†y cu·ªëi)
          let diffDays = Math.floor(
            (Date.UTC(end.getFullYear(), end.getMonth(), end.getDate()) -
              Date.UTC(start.getFullYear(), start.getMonth(), start.getDate()))
            / (1000 * 60 * 60 * 24)
          ) + 1;

          if (orderDetails.find(d => d.id === id)) {
            alert("‚ö†Ô∏è Thi·∫øt b·ªã n√†y ƒë√£ ƒë∆∞·ª£c th√™m!");
            return;
          }

          orderDetails.push({ id, name, price, start, end, seriNumber, quantity: 1, days: diffDays });
          renderOrderTable();
        });


        // ==========================
        // ‚ùå X√≥a thi·∫øt b·ªã
        // ==========================
        $(document).on('click', '.btnDelete', function () {
          let id = $(this).data('id');
          orderDetails = orderDetails.filter(d => d.id !== id);
          renderOrderTable();
        });


        // ==========================
        // üßæ Render l·∫°i b·∫£ng chi ti·∫øt ƒë∆°n
        // ==========================
        function renderOrderTable() {
          let tbody = $('#tblOrderDetail tbody');
          tbody.empty();
          let total = 0;

          orderDetails.forEach((d, i) => {
            let discount = d.discount || 0;
            let subtotal = d.price * d.days * (1 - discount / 100);
            total += subtotal;
            let price = Math.round(Number(d.price));
            tbody.append(`
                        <tr>
                          <td>${i + 1}</td>
                          <td>${d.name}</td>
                          <td>${d.seriNumber}</td>
                          <td>${price.toLocaleString('vi-VN',{ maximumFractionDigits: 0 })} ‚Ç´</td>
                          <td>${d.start.toLocaleDateString('vi-VN')}</td>
                          <td>${d.end.toLocaleDateString('vi-VN')}</td>
                          <td>${d.days}</td>
                          <td><input type="number" class="form-control form-control-sm discount-input" 
                         data-id="${d.id}" value="${discount}" min="0" max="100"></td>
                          <td>${subtotal.toLocaleString('vi-VN')} ‚Ç´</td>
                          <td><button class="btn btn-sm btn-danger btnDelete" data-id="${d.id}">   <i class="fa fa-trash color-white"></i> X√≥a</button></td>
                        </tr>
                      `);
          });

          $('#totalAmount').text(total.toLocaleString());
        }


        // ==========================
        // ‚úèÔ∏è C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ho·∫∑c s·ªë ng√†y
        // ==========================
        $(document).on('change', '.qty, .days', function () {
          let id = $(this).data('id');
          let value = parseInt($(this).val());
          let key = $(this).hasClass('qty') ? 'quantity' : 'days';
          orderDetails = orderDetails.map(d => d.id === id ? { ...d, [key]: value } : d);
          renderOrderTable();
        });
        // L·∫Øng nghe khi ng∆∞·ªùi d√πng nh·∫≠p % gi·∫£m gi√°
        $(document).on('input', '.discount-input', function () {
          let id = $(this).data('id');
          let discount = parseFloat($(this).val()) || 0;

          // Gi·ªõi h·∫°n 0‚Äì100
          if (discount < 0) discount = 0;
          if (discount > 100) discount = 100;

          // C·∫≠p nh·∫≠t gi√° tr·ªã discount trong m·∫£ng orderDetails
          let item = orderDetails.find(d => d.id === id);
          if (!item) return;
          item.discount = discount;

          // T√≠nh l·∫°i th√†nh ti·ªÅn cho d√≤ng hi·ªán t·∫°i
          let subtotal = item.price * item.days * (1 - discount / 100);
          let row = $(this).closest('tr');

          // C·∫≠p nh·∫≠t l·∫°i c·ªôt th√†nh ti·ªÅn
          row.find('td:nth-last-child(2)').text(subtotal.toLocaleString() + ' ‚Ç´');

          // T√≠nh l·∫°i t·ªïng ti·ªÅn to√†n b·ªô ƒë∆°n
          let total = 0;
          orderDetails.forEach(d => {
            let sub = d.price * d.days * (1 - (d.discount || 0) / 100);
            total += sub;
          });

          $('#totalAmount').text(total.toLocaleString() + ' ‚Ç´');
        });
        // ‚úÖ G·∫Øn h√†m t√¨m ki·∫øm v√†o global scope ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ HTML onclick
        window.searchItemAsset = function (controller, searchId, dateId1, dateId2, tableContainer = "#table-container") {
          const keyword = $(searchId).val();
          const date1 = $(dateId1).val();
          const date2 = $(dateId2).val();

          if (!date1 || !date2) {
            alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn c·∫£ ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c');
            return;
          }

          let start = new Date(date1);
          let end = new Date(date2);
          let today = new Date();
          today.setHours(0, 0, 0, 0);
          start.setHours(0, 0, 0, 0);
          end.setHours(0, 0, 0, 0);

          // Ki·ªÉm tra ng√†y b·∫Øt ƒë·∫ßu ph·∫£i l√† h√¥m nay
          if (start.getTime() < today.getTime()) {
            alert('‚ö†Ô∏è Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i l√† h√¥m nay (' + today.toLocaleDateString('vi-VN') + ')');
            return;
          }

          // Ki·ªÉm tra ng√†y k·∫øt th√∫c ph·∫£i >= ng√†y b·∫Øt ƒë·∫ßu
          if (end.getTime() < start.getTime()) {
            alert('‚ö†Ô∏è Ng√†y k·∫øt th√∫c ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng ng√†y b·∫Øt ƒë·∫ßu');
            return;
          }

          clearTimeout(window.debounceTimer);
          window.debounceTimer = setTimeout(function () {
            $.ajax({
              url: `/Admin/${controller}/SearchAsset`,
              type: 'GET',
              data: { searchName: keyword, startDate: date1, endDate: date2 },
              success: function (data) {
                $(tableContainer).html(data);
              },
              error: function () {
                console.error("Search error");
              }
            });
          }, 300);
        };
      });
      // Khi ng∆∞·ªùi d√πng thay ƒë·ªïi % gi·∫£m gi√°

    </script>
}